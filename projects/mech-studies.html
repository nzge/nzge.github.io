<html > 
  <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nathan Ge - Mechanism Studies</title>
  <meta name="description" content="Study of various mechanisms for current and future implementation">
  
  <!-- favicon -->
  <link rel="icon" type="image/png" href="/assets/media/nathan/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/assets/media/nathan/favicon/favicon.svg" />
  <link rel="shortcut icon" href="/assets/media/nathan/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/media/nathan/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="/assets/media/nathan/favicon/site.webmanifest" />
  
  <link type="application/atom+xml" rel="alternate" href="https://nzge.github.io/feed.xml" title="My Website" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mechanism Studies | My Website</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Mechanism Studies" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Study of various mechanisms for current and future implementation" />
<meta property="og:description" content="Study of various mechanisms for current and future implementation" />
<link rel="canonical" href="https://nzge.github.io/projects/mech-studies.html" />
<meta property="og:url" content="https://nzge.github.io/projects/mech-studies.html" />
<meta property="og:site_name" content="My Website" />
<meta property="og:image" content="https://nzge.github.io/placeholder.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-03-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://nzge.github.io/placeholder.jpg" />
<meta property="twitter:title" content="Mechanism Studies" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-03-10T00:00:00+00:00","datePublished":"2025-03-10T00:00:00+00:00","description":"Study of various mechanisms for current and future implementation","headline":"Mechanism Studies","image":"https://nzge.github.io/placeholder.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://nzge.github.io/projects/mech-studies.html"},"url":"https://nzge.github.io/projects/mech-studies.html"}</script>
<!-- End Jekyll SEO tag -->


  <!-- google fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:100,100i,300,300i,400,400i,500,500i,700,700i" rel="stylesheet"> 

  <!-- stylesheet -->
  <!-- Automatically include all CSS files in /assets/css/ -->
      <link rel="stylesheet" type="text/css" href="/assets/css/animate.min.css">
  <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>

<!-- Include js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/assets/js/main.js"></script>
<script src="//instant.page/5.2.0" type="module" integrity="sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
<script type="text/javascript" async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>
  

  <button id="backToTop" title="Back to top">↑</button>

  <div class="btn" id="toggle-btn">
  <div id="hamburger">
    <span></span>
  </div>
</div>

<!-- <div class="overlay">
  <svg viewBox="0 0 1000 1000"> 
    <path d="M0 2S175 1 500 1s500 1 500 1V0H0Z"></path>
  </svg>
</div> */ -->

<div class="menu">

</div>

  <body>  

     <!--------------- navbar starts here --------------->
<nav class="navbar"> 
  <div class="name animate__animated animate__fadeInUp" style="display: flex; align-items: center; gap: 10px;">
    <a href="/index.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
      <span>nathan</span> 
      <img src="/assets/media/nathan/Nathan-red_block.svg" alt=" " style="width: 35px; height: auto; margin-left: 2px;">
    </a>
  </div>

  <ul class="nav-select">
    <li class="nav-item"><a href="/index.html">home.</a></li>
    <li class="nav-item"><a href="/pages/about.html">about me.</a></li>
    <li class="nav-item"><a href="/pages/work.html">work.</a></li>
    <li class="nav-item"><a href="/pages/blog.html">blog.</a></li>
    <li class="nav-item"><a href="/pages/contact.html">contact.</a></li>
  </ul>
</nav>


    <div class="gif-left">
  <img id="gif-left" alt="Left GIF">
</div>

<div class="gif-right">
  <img id="gif-right" alt="Right GIF">
</div>

<header>
  <div class="container">
    <div class="go-back" onclick="goBack()">Go Back</div>
    <h2>Mechanism Studies</h2>
    
      <a href="https://github.com/nzge/mechanism-studies" target="_blank" rel="noopener noreferrer">Repo</a>
    
  </div>
</header>


<div class="container">
  
    <nav class="toc-box">
      <p>Table of Contents</p>
      <ul><li><a href="#foc-field-oriented-control">FOC (Field oriented Control)</a><ul><li><a href="#theory">Theory</a><ul><li><a href="#how-does-a-bldc-work">How Does a BLDC Work?</a></li><li><a href="#the-control-solution-of-foc">The control solution of FOC</a><ul><li><a href="#1-rotor-position-sensingestimation">1. Rotor Position sensing/estimation</a></li><li><a href="#2-clarke--park-transformation">2. Clarke + Park transformation</a></li><li><a href="#3-control-loop">3. Control Loop</a></li><li><a href="#4-inverse-parke--inverse-parke">4. Inverse Parke + Inverse Parke</a></li><li><a href="#5-inverter-pwm-output">5. Inverter PWM output</a></li></ul></li></ul></li><li><a href="#firmware">Firmware</a></li><li><a href="#build-log">Build Log</a></li></ul></li><li><a href="#capstan-drive">Capstan Drive</a><ul><li><a href="#the-capstan-equation">The Capstan Equation</a></li><li><a href="#components">Components</a></li><li><a href="#build-log-1">Build Log</a></li></ul></li><li><a href="#harmonic-drive">Harmonic Drive</a><ul><li><a href="#components-1">Components</a></li><li><a href="#build-log-2">Build Log</a></li></ul></li><li><a href="#cycloidal-drive">Cycloidal Drive</a><ul><li><a href="#parametric-model">Parametric Model</a></li><li><a href="#build-log-3">Build Log</a></li></ul></li><li><a href="#compliant-mechanisms">Compliant Mechanisms</a><ul><li><a href="#build-log-4">Build Log</a></li></ul></li><li><a href="#rolling-joints">Rolling Joints</a><ul><li><a href="#build-log-5">Build Log</a></li></ul></li><li><a href="#continuous-variable-transmission-cvt">Continuous Variable Transmission (CVT)</a><ul><li><a href="#build-log-6">Build Log</a></li></ul></li><li><a href="#references">References</a><ul><li><a href="#foc">FOC</a></li><li><a href="#capstan">Capstan</a></li><li><a href="#compliant-mechanisms-1">Compliant Mechanisms</a></li><li><a href="#cycloidal">Cycloidal</a></li><li><a href="#harmonic">Harmonic</a></li><li><a href="#rolling-joint">Rolling Joint</a></li><li><a href="#cvt">CVT</a></li><li><a href="#sources">Sources</a></li></ul></li></ul>
    </nav>
  
  <div>
    <article class="markdown-body">
      <h1 id="foc-field-oriented-control">FOC (Field oriented Control)</h1>
<p>Field Oriented Control (FOC) is a control strategy most traditionally used for AC motors (typically permanent magnet synchronous motors (PMSMs) or induction motors) that enables precise control of torque and speed by decoupling the motor’s stator currents into two orthogonal components.</p>

<p>FOC transforms three-phase stator currents into a rotating reference frame aligned with the rotor’s magnetic field, allowing independent control of:<br />
Torque-producing current $i_q$<br />
Flux-producing current $i_d$<br />
This approach mimics the control strategy used in DC motors, where torque and flux can be independently regulated.</p>

<p>Field Oriented Control (FOC) can also be applied to Brushless DC (BLDC) motors, even though BLDCs are traditionally driven with simpler trapezoidal control (commutation-based). 
Even though BLDC motors are often controlled using six-step trapezoidal commutation, they are structurally similar to Permanent Magnet Synchronous Motors (PMSMs), which are typically sinusoidally wound and driven with FOC. FOC can treat a BLDC motor like a PMSM by assuming sinusoidal behavior and applying the same transformations and control strategy. Using FOC with BLDC motors enables smoother operation, higher efficiency, quieter performance, and precise torque/speed control, especially at low speeds or in dynamic applications.</p>

<h2 id="theory">Theory</h2>

<h3 id="how-does-a-bldc-work">How Does a BLDC Work?</h3>

<h3 id="the-control-solution-of-foc">The control solution of FOC</h3>
<h4 id="1-rotor-position-sensingestimation">1. Rotor Position sensing/estimation</h4>

<h4 id="2-clarke--park-transformation">2. Clarke + Park transformation</h4>

<h4 id="3-control-loop">3. Control Loop</h4>

<h4 id="4-inverse-parke--inverse-parke">4. Inverse Parke + Inverse Parke</h4>

<h4 id="5-inverter-pwm-output">5. Inverter PWM output</h4>

<h2 id="firmware">Firmware</h2>
<p>https://simplefoc.com/</p>

<h2 id="build-log">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="capstan-drive">Capstan Drive</h1>
<p>A capstan drive is a transmission system that uses flexible tension members (cordage) to transmit rotary or linear motion between pulleys or drums. The term “capstan” comes from a vertical-axled rotating machine developed for sailing ships to mechanically enhance the pulling force of sailors hauling ropes (hawsers) and cables. The capstan mechanism exploits the frictional interaction between a rotating capstan and cordage, and can be leveraged in mechanical applications.</p>

<h2 id="the-capstan-equation">The Capstan Equation</h2>
<p>https://en.wikipedia.org/wiki/Capstan_equation</p>

<h2 id="components">Components</h2>

<table>
  <thead>
    <tr>
      <th>Item</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://dynamica-ropes.com/products/dm20/">Rope</a></td>
      <td>Vectran, Kevlar, DM20</td>
    </tr>
  </tbody>
</table>

<h2 id="build-log-1">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="harmonic-drive">Harmonic Drive</h1>
<p>A harmonic drive is a type of strain wave gearing that uses the elastic mechanics of metals to create a high-precision, zero-backlash rotary actuator. It consists of three main components: a wave generator, a flex spline, and a circular spline.</p>

<h2 id="components-1">Components</h2>

<h2 id="build-log-2">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="cycloidal-drive">Cycloidal Drive</h1>
<p>A cycloidal drive uses an eccentric input cam to spin a lobed cycloidal disc which rolls against a ring of fixed pins or rollers​. Because the disc has fewer lobes than housing pins, each input rotation causes only a small step of output motion (equal to the difference in lobes), yielding a high reduction ratio​. The lobes (often on rolling pins) distribute force over multiple contacts, giving the drive very high torque capacity and strong shock resistance with minimal backlash​. This robust design is commonly used in heavy-duty robotic joints and industrial actuators.</p>

<h2 id="parametric-model">Parametric Model</h2>

<h2 id="build-log-3">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="compliant-mechanisms">Compliant Mechanisms</h1>

<h2 id="build-log-4">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="rolling-joints">Rolling Joints</h1>

<h2 id="build-log-5">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />

<h1 id="continuous-variable-transmission-cvt">Continuous Variable Transmission (CVT)</h1>

<h2 id="build-log-6">Build Log</h2>

<blockquote>
  <p>5-11-24:</p>

  <p><img src="/assets/media/mechanism_media/prints.JPG" alt="Alt text" style="height:400px;display: block; margin: auto;" /></p>
</blockquote>

<hr />
<h1 id="references">References</h1>

<h2 id="foc">FOC</h2>
<ol>
  <li></li>
</ol>

<h2 id="capstan">Capstan</h2>
<ol>
  <li>https://www.aaedmusa.com/projects/capstandrive</li>
  <li><a href="https://www.youtube.com/watch?v=ENMZsPwCUcA">Capstan Drive NEMA 17 Stepper Timing Belt</a></li>
</ol>

<h2 id="compliant-mechanisms-1">Compliant Mechanisms</h2>
<ol>
  <li><a href="https://compliantmechanisms.byu.edu/maker-resources">BYU CMR</a></li>
  <li><a href="https://www.youtube.com/watch?v=xV36ITRjP_4">“How to create effective compliant mechanisms with 3D printing” - Teaching Tech</a></li>
</ol>

<h2 id="cycloidal">Cycloidal</h2>
<ol>
  <li><a href="https://www.youtube.com/watch?v=HDVCgaDknyM&amp;t=7s">“The BEST Way to Design a Cycloidal Drive in 2024” - Nelson Howe</a></li>
  <li><a href="https://www.youtube.com/watch?v=qDtFj4PE3-o">“Parametric Cycloidal Gear Drive (Fusion 360)” - Aaed Musa</a></li>
  <li><a href="https://www.youtube.com/watch?v=jQ6LQBFZXmU&amp;t=776s">“How to Design a Cycloidal Disk in Fusion 360” - Levi Janssen</a></li>
  <li><a href="https://www.youtube.com/live/y9vLVXjz2c0?app=desktop&amp;t=457s">“Designing a cycloidal drive in Python and Fusion 360” - RoTechnic</a></li>
</ol>

<h2 id="harmonic">Harmonic</h2>
<ol>
  <li><a href="https://www.youtube.com/watch?v=xlnNj9F37MA">“What is Strain Wave Gear a.k.a. Harmonic Drive? A Perfect Gear Set For Robotics Applications!?” - How To Mechatronics</a></li>
</ol>

<h2 id="rolling-joint">Rolling Joint</h2>
<ol>
  <li><a href="https://www.youtube.com/watch?v=TQiLLcumqDw">Alternative to bearings for tiny robots</a></li>
  <li><a href="https://www.youtube.com/watch?v=utDagouxM5U">You’ve never seen the Robot Joint like this one!</a></li>
</ol>

<h2 id="cvt">CVT</h2>
<ol>
  <li><a href="https://www.youtube.com/watch?v=mWJHI7UHuys&amp;t=121s">This Is The World’s First Geared CVT and It Will Blow Your Mind - Ratio Zero Transmission</a></li>
  <li><a href="https://www.youtube.com/watch?v=vc9o-O1n81E">RatioZero - the ‘world’s first geared CVT’</a></li>
</ol>

<h2 id="sources">Sources</h2>

<!-- Hidden references trigger the footnote rendering -->
<p><span id="hidden-references"> <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">1</a></sup> <sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">2</a></sup> <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">3</a></sup> <sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">4</a></sup></span></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:3" role="doc-endnote">
      <p><strong>Book:</strong> K. Ogata. <em>Modern Control Engineering</em>. Pearson, 2010. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><strong>Website:</strong> <a href="https://example.com">“Stewart Platform Control”</a>. Accessed: March 6, 2025. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><strong>Journal:</strong> Doe, J. <em>Optimization of Robotic Mechanisms</em>. <em>Journal of Robotics Research</em>, Vol. 25, 2023, pp. 45-60. <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p><strong>Technical Report:</strong> NASA. <em>Adaptive Control for Space Robotics</em>. Tech Report No. 4567, 2022. <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </article>
  </div>
</div>

    <footer class="container wow animate__animated animate__fadeInUp" data-wow-duration="2s" data-wow-delay="0.5s"">
  <div class="footer-line"></div>
  <div class="footer-content">
    <img src="/assets/media/!misc/random/wwwbutton.gif" alt="www">
    <p>&copy; 2025 Nathan Ge 葛中骐</p>
    <div class="social-icons">
      <a href="https://github.com/nzge" target="_blank" data-no-icon><i class="fab fa-github"></i></a>
      <a href="https://x.com/ge_nathan73556" target="_blank" data-no-icon><i class="fab fa-twitter"></i></a>
      <a href="https://linkedin.com/in/nzge" target="_blank" data-no-icon><i class="fab fa-linkedin"></i></a>
      <a href="https://instagram.com/naysun_g" target="_blank" data-no-icon><i class="fab fa-instagram"></i></a>
    </div>

  </div>

  <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
  <script>
    kofiWidgetOverlay.draw('nathange', {
      type: 'floating-chat',
      'floating-chat.donateButton.text': 'Support me',
      'floating-chat.donateButton.background-color': 'rgba(24, 22, 22, 0.6)', // opacity controlled here
      'floating-chat.donateButton.text-color': '#fff'
    });
  </script>


</footer>
    
    <style>
  .videoWrapper {
    position: relative;
    padding-bottom: 56.333%;
    height: 0;
      background: black;
  }
  .videoWrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
      border: 0;
  }    

</style>
  
<script>
  function get_youtube_id(url) {
      var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
      return (url.match(p)) ? RegExp.$1 : false;
  }
  function vimeo_embed(url,el) {
      var id = false;
      $.ajax({
        url: 'https://vimeo.com/api/oembed.json?url='+url,
        async: true,
        success: function(response) {
          if(response.video_id) {
            id = response.video_id;
            if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
            if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
            var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
            if(autoplay==1) theInnerHTML += '&autoplay=1';
            if(loop==1) theInnerHTML += '&loop=1';
            theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>'; 
            el.innerHTML = theInnerHTML;
          }
        }
      });
  }
  function video_embed() {
      var p = document.getElementsByTagName('p');
      for(var i = 0; i < p.length; i++) {
          //check if this is an external url (that starts with https:// or http://
          if (p[i].innerHTML.indexOf("http://") == 0 ||
              p[i].innerHTML.indexOf("https://") == 0) {
              var youtube_id = get_youtube_id(p[i].innerHTML);
              if(youtube_id) {
                  if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                  if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                  var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                  if(autoplay==1) theInnerHTML += '&autoplay=1';
                  if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                  if(p[i].innerHTML.indexOf('start=') !== -1) theInnerHTML += '&start='+p[i].innerHTML.substring(p[i].innerHTML.indexOf('start=')+6);
                  theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                  p[i].innerHTML = theInnerHTML;
              }
              if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                  //ask vimeo for the id and place the embed
                  vimeo_embed(p[i].innerHTML,p[i]);
              }
          }
      }
  }
  video_embed();
  
  function mp3_embed() {
      var p = document.getElementsByTagName('p');
      for(var i = 0; i < p.length; i++) {
          if(p[i].innerHTML.indexOf('.mp3') !== -1) {
              var str = p[i].innerHTML.split('?');
              if(str.length == 1) str[1] = '';
              var str1 = str[1];
              str1 = str1.replace('&','').replace('&','');
              str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
              str1 = str1.replace('loop=1','').replace('loop=0','');
              str1 = str1.replace('controls=0','').replace('controls=1','');
  
              if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                  if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                  if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                  if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                  var newInnerHTML = '<audio';
                  if(autoplay==1) newInnerHTML += ' autoplay';
                  if(loop==1) newInnerHTML += ' loop';
                  if(controls==1) newInnerHTML += ' controls';
                  newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                  p[i].innerHTML = newInnerHTML;
              }
          }
      }
    }
    mp3_embed();

  </script>
      
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    const defaultIconUrl = "/assets/media/!misc/icons/link.svg"; // Fallback icon
  
    document.querySelectorAll("a[href]").forEach(link => {
      const href = link.getAttribute("href");
      if (!href) return;
  
      const isExternal = /^https?:\/\//i.test(href) && !href.includes(window.location.hostname);
  
      // Skip icon if explicitly opted out
      if (link.hasAttribute("data-no-icon")) return;
  
      if (isExternal) {
        // Open in new tab securely
        link.setAttribute("target", "_blank");
        link.setAttribute("rel", "noopener noreferrer");
  
        // Avoid duplicate icons
        if (link.querySelector("img")) return;
  
        // Add styling class for vertical centering
        link.classList.add("icon");
  
        // Detect if icon should go to the right
        const iconRight = link.classList.contains("icon-right") ||
                          link.getAttribute("data-icon") === "right" ||
                          link.getAttribute("class")?.includes("icon-right");
  
        try {
          const url = new URL(href);
          const faviconUrl = `https://www.google.com/s2/favicons?sz=16&domain=${url.hostname}`;
  
          const icon = document.createElement("img");
          icon.src = faviconUrl;
          icon.alt = "";
          icon.style.width = "16px";
          icon.style.height = "16px";
  
          // Basic alignment and spacing
          icon.style.margin = iconRight ? "0 0 0 4px" : "0 4px 0 0";
  
          // Fallback to default icon if favicon fails to load
          icon.onerror = () => { icon.src = defaultIconUrl; };
  
          // Insert icon in correct position
          if (iconRight) link.append(icon);
          else link.prepend(icon);
        } catch (e) {
          const fallbackIcon = document.createElement("img");
          fallbackIcon.src = defaultIconUrl;
          fallbackIcon.alt = "";
          fallbackIcon.style.width = "16px";
          fallbackIcon.style.height = "16px";
          fallbackIcon.style.margin = iconRight ? "0 0 0 4px" : "0 4px 0 0";
          if (iconRight) link.append(fallbackIcon);
          else link.prepend(fallbackIcon);
        }
      }
    });
  });
  </script>
  
  </body>

</html>

